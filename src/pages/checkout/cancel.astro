---
/**
 * Checkout Cancel Page
 * 
 * Handles cancelled/abandoned checkout flow:
 * - Shows cancellation message
 * - Provides option to return to marketplace
 * - Provides option to retry checkout (re-lock the listing)
 * - Shows info about lock expiration
 */

import BaseLayout from "../../layouts/BaseLayout.astro";

// Get order_id from URL if available
const orderId = Astro.url.searchParams.get("order_id");
const listingId = Astro.url.searchParams.get("listing_id");
---

<BaseLayout title="Checkout Cancelled - Lock It In" description="Your checkout was cancelled. You can return to the marketplace or retry your purchase.">
  <div class="neo-container py-8">
    <div class="max-w-2xl mx-auto">
      {/* Cancel Message */}
      <div class="neo-card text-center py-12 mb-6">
        <div class="neo-extrude-lg w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center text-5xl bg-gradient-to-br from-amber-400 to-orange-500 text-white shadow-lg shadow-orange-500/30">
          ✕
        </div>
        <h1 class="font-display font-bold text-3xl mb-2">Checkout Cancelled</h1>
        <p class="text-secondary text-lg mb-6 max-w-md mx-auto">
          Your payment was not completed. Don't worry—your card is still available if you'd like to try again.
        </p>
        <div class="neo-status-warning mx-auto w-fit text-base">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" x2="9" y1="9" y2="15"/>
            <line x1="9" x2="15" y1="9" y2="15"/>
          </svg>
          Payment Not Completed
        </div>
      </div>

      {/* Lock Status Info */}
      <div class="neo-card mb-6">
        <h3 class="font-display font-bold text-lg mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4"/>
            <path d="M12 8h.01"/>
          </svg>
          About Your Lock
        </h3>
        <div class="space-y-3 text-sm">
          <p class="text-secondary">
            When you started checkout, we temporarily reserved this card for you. Here's what you need to know:
          </p>
          <ul class="space-y-2 text-secondary">
            <li class="flex items-start gap-2">
              <span class="text-amber-500 mt-0.5">•</span>
              <span><strong>Locks expire after 10 minutes</strong> — If you wait too long, another buyer may purchase this card.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-green-500 mt-0.5">•</span>
              <span><strong>No charges were made</strong> — Your payment method was not charged.</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="text-blue-500 mt-0.5">•</span>
              <span><strong>Your cart is not saved</strong> — You'll need to start checkout again to purchase this card.</span>
            </li>
          </ul>
        </div>
        {orderId && (
          <div class="mt-4 pt-4 border-t border-gray-200/30">
            <p class="text-xs text-muted">
              Order Reference: <span class="font-mono">{orderId.slice(-8).toUpperCase()}</span>
            </p>
          </div>
        )}
      </div>

      {/* Action Buttons */}
      <div class="neo-card">
        <h3 class="font-display font-bold text-lg mb-4">What would you like to do?</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {/* Retry Checkout */}
          <button 
            id="retry-checkout-btn"
            class="neo-action neo-action-lg justify-center group"
            data-listing-id={listingId}
            data-order-id={orderId}
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="group-hover:rotate-180 transition-transform duration-500">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
            </svg>
            <span id="retry-text">Try Again</span>
          </button>

          {/* Back to Marketplace */}
          <a href="/" class="neo-button neo-button-lg justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M3 3h18"/>
              <path d="M3 9h18"/>
              <path d="M3 15h18"/>
              <path d="M3 21h18"/>
            </svg>
            Browse Marketplace
          </a>
        </div>

        {/* Additional Options */}
        <div class="neo-divider my-6" />
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <a href="/purchases" class="neo-button neo-button-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/>
              <path d="M3 6h18"/>
              <path d="M16 10a4 4 0 0 1-8 0"/>
            </svg>
            View My Purchases
          </a>
          <a href="/help" class="neo-button neo-button-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
              <path d="M12 17h.01"/>
            </svg>
            Get Help
          </a>
          <a href="/support" class="neo-button neo-button-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Contact Support
          </a>
        </div>
      </div>

      {/* FAQ Section */}
      <div class="neo-card mt-6">
        <h3 class="font-display font-bold text-lg mb-4">Frequently Asked Questions</h3>
        <div class="space-y-4">
          <div class="neo-recess-sm rounded-lg p-4">
            <h4 class="font-display font-semibold text-sm mb-1">Why was my checkout cancelled?</h4>
            <p class="text-sm text-secondary">
              You may have closed the payment window, clicked "Back", or experienced a connection issue. No charges were made to your account.
            </p>
          </div>
          <div class="neo-recess-sm rounded-lg p-4">
            <h4 class="font-display font-semibold text-sm mb-1">Will the card still be available?</h4>
            <p class="text-sm text-secondary">
              Cards are locked for 10 minutes during checkout. If your lock has expired, another buyer may have purchased it. Try again to see if it's still available.
            </p>
          </div>
          <div class="neo-recess-sm rounded-lg p-4">
            <h4 class="font-display font-semibold text-sm mb-1">Can I save my progress?</h4>
            <p class="text-sm text-secondary">
              For security reasons, checkout progress cannot be saved. You'll need to complete your purchase in one session.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Cancel Page Logic
    // ============================================

    const retryBtn = document.getElementById("retry-checkout-btn");
    const retryText = document.getElementById("retry-text");

    retryBtn?.addEventListener("click", async () => {
      const listingId = retryBtn.getAttribute("data-listing-id");
      const orderId = retryBtn.getAttribute("data-order-id");

      // Show loading state
      retryText.textContent = "Resuming...";
      retryBtn.disabled = true;
      retryBtn.classList.add("opacity-75");

      try {
        // If we have a listingId, redirect to the listing or checkout
        if (listingId) {
          // Redirect to the listing page with checkout intent
          window.location.href = `/?checkout=${listingId}`;
          return;
        }

        // If we only have orderId, try to get the listing from the order
        if (orderId) {
          const { ConvexReactClient } = await import("convex/react");
          const { api } = await import("../../../convex/_generated/api");
          
          const client = new ConvexReactClient(import.meta.env.PUBLIC_CONVEX_URL);
          const order = await client.query(api.orders.getById, { orderId });
          
          if (order?.listingId) {
            window.location.href = `/?checkout=${order.listingId}`;
            return;
          }
        }

        // Fallback: redirect to marketplace
        window.location.href = "/";
      } catch (error) {
        console.error("Error retrying checkout:", error);
        retryText.textContent = "Try Again";
        retryBtn.disabled = false;
        retryBtn.classList.remove("opacity-75");
        
        // Show error and redirect to marketplace as fallback
        alert("Unable to resume checkout. Returning to marketplace.");
        window.location.href = "/";
      }
    });
  </script>
</BaseLayout>

---
/**
 * Checkout Success Page
 * 
 * Handles post-payment success flow:
 * - Gets session_id from URL params
 * - Queries order status from Convex
 * - Shows processing state while waiting for webhook
 * - Polls for order status updates
 * - Displays success message with order details
 */

import BaseLayout from "../../layouts/BaseLayout.astro";

// Get session_id from URL
const sessionId = Astro.url.searchParams.get("session_id");
---

<BaseLayout title="Order Confirmed - Lock It In" description="Your order has been confirmed. Thank you for your purchase!">
  <div class="neo-container py-8">
    <div id="success-content" class="max-w-2xl mx-auto">
      {/* Initial Loading State */}
      <div id="loading-state" class="neo-card text-center py-16">
        <div class="neo-loading w-20 h-20 mx-auto mb-6 rounded-full neo-extrude-lg flex items-center justify-center">
          <svg class="animate-spin h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
          </svg>
        </div>
        <h2 class="font-display font-bold text-2xl mb-2">Processing Your Order</h2>
        <p class="text-secondary max-w-sm mx-auto">
          We're confirming your payment. This usually takes just a few moments...
        </p>
        <div class="mt-6 neo-status-warning mx-auto w-fit">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          Awaiting Confirmation
        </div>
      </div>

      {/* Success State - Hidden initially */}
      <div id="success-state" class="hidden">
        <div class="neo-card text-center py-12 mb-6">
          <div class="neo-extrude-lg w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center text-5xl bg-gradient-to-br from-green-400 to-emerald-500 text-white shadow-lg shadow-green-500/30">
            ‚úì
          </div>
          <h1 class="font-display font-bold text-3xl mb-2 text-gradient">Order Confirmed!</h1>
          <p class="text-secondary text-lg mb-6">
            Thank you for your purchase. Your order is now being processed.
          </p>
          <div class="neo-status mx-auto w-fit text-base">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            Payment Successful
          </div>
        </div>

        {/* Order Details */}
        <div id="order-details" class="neo-card mb-6">
          <h3 class="font-display font-bold text-xl mb-4">Order Details</h3>
          <div class="space-y-3">
            <div class="flex justify-between text-sm">
              <span class="text-secondary">Order ID</span>
              <span id="order-id" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">--</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-secondary">Item</span>
              <span id="order-item" class="font-medium text-right max-w-[200px] truncate">--</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-secondary">Amount Paid</span>
              <span id="order-amount" class="font-bold">--</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-secondary">Date</span>
              <span id="order-date">--</span>
            </div>
          </div>
          <div class="neo-divider my-4" />
          <div class="neo-recess-sm rounded-lg p-4 bg-blue-50/50">
            <div class="flex items-start gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="text-blue-500 shrink-0 mt-0.5">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4"/>
                <path d="M12 8h.01"/>
              </svg>
              <div>
                <p class="text-sm font-medium text-blue-900">What happens next?</p>
                <p class="text-sm text-blue-700 mt-1">
                  The seller will be notified and will ship your card within 2 business days. 
                  You'll receive tracking information via email.
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* Next Steps */}
        <div class="neo-card">
          <h3 class="font-display font-bold text-lg mb-4">Next Steps</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <a href="/purchases" class="neo-button neo-button-lg justify-center group">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="group-hover:scale-110 transition-transform">
                <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/>
                <path d="M3 6h18"/>
                <path d="M16 10a4 4 0 0 1-8 0"/>
              </svg>
              View Your Purchases
            </a>
            <a href="/" class="neo-button neo-button-lg justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
              Back to Marketplace
            </a>
          </div>
        </div>
      </div>

      {/* Error State - Hidden initially */}
      <div id="error-state" class="hidden">
        <div class="neo-card text-center py-12">
          <div class="neo-extrude-lg w-20 h-20 mx-auto mb-6 rounded-full flex items-center justify-center text-4xl text-red-500">
            ‚ö†Ô∏è
          </div>
          <h2 class="font-display font-bold text-2xl mb-2">Unable to Confirm Order</h2>
          <p id="error-message" class="text-secondary mb-6">
            We couldn't verify your payment status. Please contact support if you believe this is an error.
          </p>
          <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <a href="/" class="neo-action">
              Return to Marketplace
            </a>
            <a href="/support" class="neo-button">
              Contact Support
            </a>
          </div>
        </div>
      </div>

      {/* Missing Session ID State */}
      <div id="missing-session-state" class="hidden">
        <div class="neo-card text-center py-12">
          <div class="neo-extrude-lg w-20 h-20 mx-auto mb-6 rounded-full flex items-center justify-center text-4xl">
            üîç
          </div>
          <h2 class="font-display font-bold text-2xl mb-2">No Order Found</h2>
          <p class="text-secondary mb-6">
            We couldn't find your order information. If you just completed a purchase, please check your email for confirmation.
          </p>
          <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <a href="/purchases" class="neo-action">
              View My Purchases
            </a>
            <a href="/" class="neo-button">
              Back to Marketplace
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Success Page Logic
    // ============================================
    
    const SESSION_ID = new URLSearchParams(window.location.search).get("session_id");
    const POLL_INTERVAL = 2000; // 2 seconds
    const MAX_POLL_ATTEMPTS = 30; // 60 seconds total
    
    let pollAttempts = 0;
    let pollTimer: number | null = null;

    // DOM Elements
    const loadingState = document.getElementById("loading-state");
    const successState = document.getElementById("success-state");
    const errorState = document.getElementById("error-state");
    const missingSessionState = document.getElementById("missing-session-state");
    const errorMessage = document.getElementById("error-message");

    // Update order details in DOM
    function updateOrderDetails(order: any) {
      const orderIdEl = document.getElementById("order-id");
      const orderItemEl = document.getElementById("order-item");
      const orderAmountEl = document.getElementById("order-amount");
      const orderDateEl = document.getElementById("order-date");

      if (orderIdEl) orderIdEl.textContent = order._id?.slice(-8).toUpperCase() || "--";
      if (orderItemEl) orderItemEl.textContent = order.listingTitle || "Trading Card";
      if (orderAmountEl) orderAmountEl.textContent = order.priceCents 
        ? `$${(order.priceCents / 100).toFixed(2)}` 
        : "--";
      if (orderDateEl) orderDateEl.textContent = order.updatedAt 
        ? new Date(order.updatedAt).toLocaleDateString() 
        : new Date().toLocaleDateString();
    }

    // Show specific state
    function showState(state: "loading" | "success" | "error" | "missing") {
      loadingState?.classList.add("hidden");
      successState?.classList.add("hidden");
      errorState?.classList.add("hidden");
      missingSessionState?.classList.add("hidden");

      switch (state) {
        case "loading":
          loadingState?.classList.remove("hidden");
          break;
        case "success":
          successState?.classList.remove("hidden");
          break;
        case "error":
          errorState?.classList.remove("hidden");
          break;
        case "missing":
          missingSessionState?.classList.remove("hidden");
          break;
      }
    }

    // Poll for order status
    async function pollOrderStatus() {
      if (!SESSION_ID) {
        showState("missing");
        return;
      }

      try {
        // Import Convex client dynamically
        const { ConvexReactClient } = await import("convex/react");
        const { api } = await import("../../../convex/_generated/api");
        
        const client = new ConvexReactClient(import.meta.env.PUBLIC_CONVEX_URL);
        
        // Query order by Stripe session ID with listing details
        const order = await client.query(api.orders.getWithListingByStripeSession, { 
          sessionId: SESSION_ID 
        });

        if (order) {
          if (order.status === "paid") {
            // Payment confirmed!
            updateOrderDetails(order);
            showState("success");
            if (pollTimer) clearInterval(pollTimer);
            return;
          } else if (["cancelled", "expired"].includes(order.status)) {
            // Payment failed
            if (errorMessage) {
              errorMessage.textContent = `Your order status is: ${order.status}. Please contact support if you believe this is an error.`;
            }
            showState("error");
            if (pollTimer) clearInterval(pollTimer);
            return;
          }
          // Still processing, continue polling
        }

        pollAttempts++;
        if (pollAttempts >= MAX_POLL_ATTEMPTS) {
          // Max attempts reached, show success anyway (webhook might be delayed)
          showState("success");
          if (pollTimer) clearInterval(pollTimer);
        }
      } catch (error) {
        console.error("Error polling order status:", error);
        pollAttempts++;
        if (pollAttempts >= MAX_POLL_ATTEMPTS) {
          if (errorMessage) {
            errorMessage.textContent = "We're having trouble confirming your order. Please check your email or contact support.";
          }
          showState("error");
          if (pollTimer) clearInterval(pollTimer);
        }
      }
    }

    // Initialize
    if (!SESSION_ID) {
      showState("missing");
    } else {
      showState("loading");
      // Initial poll
      pollOrderStatus();
      // Start polling
      pollTimer = window.setInterval(pollOrderStatus, POLL_INTERVAL);
    }

    // Cleanup on page unload
    window.addEventListener("beforeunload", () => {
      if (pollTimer) clearInterval(pollTimer);
    });
  </script>
</BaseLayout>
